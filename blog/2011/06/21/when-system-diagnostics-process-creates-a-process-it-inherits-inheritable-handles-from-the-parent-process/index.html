<!DOCTYPE html>
<html class="no-js" lang="en-us">
  <head>
    <meta charset="utf-8">
    
    <link rel="preload" href="http://www.sadrobot.co.nz/files/muli-latin-200.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="http://www.sadrobot.co.nz/files/muli-latin-400.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="http://www.sadrobot.co.nz/files/muli-latin-800.woff2" as="font" type="font/woff2" crossorigin>

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
     
    <title>When System.Diagnostics.Process creates a process, it inherits inheritable handles from the parent process. | Sad Robot</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
     <meta name="generator" content="Hugo 0.48" />

      
        <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
      

     <link href='/dist/main.css' rel='stylesheet' type="text/css" /><meta property="og:title" content="When System.Diagnostics.Process creates a process, it inherits inheritable handles from the parent process." />
<meta property="og:description" content="This post covers the cause of a bug I ran into at work.
Our application would check for available updates when it started, and if they were found, it would launch the installer directly and exit the application immediately, so that the installer could run without encountering file locks.
The installer was complaining our executable was still locked, meaning it had to schedule the overwrite of the old file with the new one after a reboot." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.sadrobot.co.nz/blog/2011/06/21/when-system-diagnostics-process-creates-a-process-it-inherits-inheritable-handles-from-the-parent-process/" /><meta property="article:published_time" content="2011-06-21T16:06:13&#43;00:00"/>
<meta property="article:modified_time" content="2018-11-28T20:46:18&#43;13:00"/>
<meta itemprop="name" content="When System.Diagnostics.Process creates a process, it inherits inheritable handles from the parent process.">
<meta itemprop="description" content="This post covers the cause of a bug I ran into at work.
Our application would check for available updates when it started, and if they were found, it would launch the installer directly and exit the application immediately, so that the installer could run without encountering file locks.
The installer was complaining our executable was still locked, meaning it had to schedule the overwrite of the old file with the new one after a reboot.">


<meta itemprop="datePublished" content="2011-06-21T16:06:13&#43;00:00" />
<meta itemprop="dateModified" content="2011-06-21T16:06:13&#43;00:00" />
<meta itemprop="wordCount" content="726">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://www.sadrobot.co.nz/images/gohugoio-card.png"/>

<meta name="twitter:title" content="When System.Diagnostics.Process creates a process, it inherits inheritable handles from the parent process."/>
<meta name="twitter:description" content="This post covers the cause of a bug I ran into at work.
Our application would check for available updates when it started, and if they were found, it would launch the installer directly and exit the application immediately, so that the installer could run without encountering file locks.
The installer was complaining our executable was still locked, meaning it had to schedule the overwrite of the old file with the new one after a reboot."/>
<meta name="twitter:site" content="@whup"/>





  </head>
  <body class="ma0 sans-serif bg-primary-color-light">
    
<nav class="bg-primary-color-dark pv4 w-100" role="navigation">

  <div class="center flex-ns flex-wrap items-center justify-start mw9">

    <h1 class="dim f3 lh-solid ml0-ns mr0 mr4-l mv0 pl3 pl4-ns">
      <a href="http://www.sadrobot.co.nz/" class="link white">
         Sad Robot
      </a>
    </h1>
    <ul class="list ma0 pa0 dn dib-l">
      
        <li class="f5 dib mr4" role="menuitem">
            
          <a href="/blog/" class="dim link light-silver">
            Blog
              
            
            
          </a>
        </li>
      
        <li class="f5 dib mr4" role="menuitem">
            
          <a href="/wiki/" class="dim link light-silver">
            Wiki
              
            
            
          </a>
        </li>
      
        <li class="f5 dib mr4" role="menuitem">
            
          <a href="/games/" class="dim link light-silver">
            Gaming
              
            
            
          </a>
        </li>
      
        <li class="f5 dib mr4" role="menuitem">
            
          <a href="/ipfilter/" class="dim link light-silver">
            IPFilter
              
            
            
          </a>
        </li>
      
        <li class="f5 dib mr4" role="menuitem">
            
          <a href="https://github.com/davidmoore/" class="dim link light-silver">
            GitHub
              
            
            
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="10" height="10" viewBox="0 0 32 32" class="fill-current v-base" aria-label="External Link">
<path d="M25.152 16.576v5.696q0 2.144-1.504 3.648t-3.648 1.504h-14.848q-2.144 0-3.648-1.504t-1.504-3.648v-14.848q0-2.112 1.504-3.616t3.648-1.536h12.576q0.224 0 0.384 0.16t0.16 0.416v1.152q0 0.256-0.16 0.416t-0.384 0.16h-12.576q-1.184 0-2.016 0.832t-0.864 2.016v14.848q0 1.184 0.864 2.016t2.016 0.864h14.848q1.184 0 2.016-0.864t0.832-2.016v-5.696q0-0.256 0.16-0.416t0.416-0.16h1.152q0.256 0 0.416 0.16t0.16 0.416zM32 1.152v9.12q0 0.48-0.352 0.8t-0.8 0.352-0.8-0.352l-3.136-3.136-11.648 11.648q-0.16 0.192-0.416 0.192t-0.384-0.192l-2.048-2.048q-0.192-0.16-0.192-0.384t0.192-0.416l11.648-11.648-3.136-3.136q-0.352-0.352-0.352-0.8t0.352-0.8 0.8-0.352h9.12q0.48 0 0.8 0.352t0.352 0.8z"></path>
</svg>

            
          </a>
        </li>
      
    </ul>

    
    <div class="db dib-ns pl3"></div>
    
    
    <span class="absolute mt1 mt2-l pr3 right-0 top-0">

  <a href="https://twitter.com/intent/follow?screen_name=whup" title="Follow on Twitter" class="link-transition twitter link dib z-999 pt3 pt0-l mr2">
    <svg height="32px" id="Layer_1" style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

  </a>

<a class="github-button needs-js link primary-color-dark" href="https://github.com/davidmoore/" data-size="large" data-show-count="false" aria-label="Star gohugoio/hugo on GitHub">Star</a>
</span>

  </div>
</nav>

    
    <main role="main" class="content-with-sidebar min-vh-100 pb7 pb0-ns">
      
  <article class="w-100 ph4 pb5 pb6-ns pt1 pt5-ns">
    <div class="flex-l">

      <div class="order-2 w-100 w-20-l ph5-m ph0-l mb4 sticky">
<aside class="fixed-lTK mw5-l right-0 f6 bl-l b--moon-gray pv4 pv0-ns ph4-l nested-list-reset nested-links nested-copy-line-height">
	

	<div date-pref>
		
			<a href="http://www.sadrobot.co.nz/blog/2011/07/18/generating-a-type-library-for-visual-basic-6-activex-components/" class="dib f6 pl1 hover-bg-light-gray br-100" title="Generating a type library for Visual Basic 6 ActiveX Components ">
				<svg class="fill-current" height="30px" viewBox="0 0 24 24" width="30px" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>

			</a>
		

		
			<a href="http://www.sadrobot.co.nz/blog/2011/06/20/net-decompilers/" class="dib f6 pr1 hover-bg-light-gray br-100" title=".NET Decompilers">
			<svg class="fill-current" height="30px" viewBox="0 0 24 24" width="30px" xmlns="http://www.w3.org/2000/svg">
    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>

			</a>
		
	</div>

</aside>
</div>

      <div class="order-1 w-60-l mw9 ph0 ph5-ns mid-gray nested-copy-line-height no-underline nested-links nested-copy-seperator nested-blockquote mt0-ns" style="flex-grow:1;">
        <div class="documentation-copy center">
          <div id="readout" class="fixed right-0 bottom-0">
          </div>
          <header class="flex-none w-100">
  
    
      <a href="/categories/entertainment" class="f6 fw8 mb0 link mid-gray dim mr3">
        ENTERTAINMENT
      </a>
    
  
  <h1 class="lh-title mb3 mv0 pt3 primary-color-dark">When System.Diagnostics.Process creates a process, it inherits inheritable handles from the parent process.</h1>
</header>

<aside class="bt bw1 pt3 mt2 mid-gray b--mid-gray fn w-100">
  

  
</aside>



<div class="prose" id="prose">



<p>This post covers the cause of a bug I ran into at work.</p>

<p>Our application would check for available updates when it started, and if they were found, it would launch the installer directly and exit the application immediately, so that the installer could run without encountering file locks.</p>

<p>The installer was complaining our executable was still locked, meaning it had to schedule the overwrite of the old file with the new one after a reboot.</p>

<p>After quite a bit of troubleshooting, it looked like while the application was launching msiexec and closing down successfully, msiexec was still grabbing the same lock handle to the exe for no good reason.</p>

<p>So what was happening?</p>

<h2 id="system-diagnostics-process">System.Diagnostics.Process</h2>

<p>When you create a new process from a .NET application, you would use the classes in the <a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.aspx" target="_blank">System.Diagnostics</a> namespace. Specifically, <a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.process.aspx" target="_blank">Process</a> and <a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.processstartinfo.aspx" target="_blank">ProcessStartInfo</a>. As we were in this case.</p>

<p>These wrap the Windows API function <a href="http://msdn.microsoft.com/en-us/library/ms682425(v=vs.85).aspx" target="_blank">CreateProcess</a> and its alternatives and supporting types.</p>

<p>If we look at the CreateProcess definition, there’s a boolean argument in there called bInheritHandles:</p>

<blockquote>
<p>BOOL WINAPI CreateProcess(</p>

<p>__in_opt� � � � LPCTSTR lpApplicationName,</p>

<p>__inout_opt� LPTSTR lpCommandLine,</p>

<p>__in_opt� � � � LPSECURITY_ATTRIBUTES lpProcessAttributes,</p>

<p>__in_opt� � � � LPSECURITY_ATTRIBUTES lpThreadAttributes,</p>

<p><strong>__in� � � � � � � � BOOL bInheritHandles</strong>,</p>

<p>__in� � � � � � � � DWORD dwCreationFlags,</p>

<p>__in_opt� � � � LPVOID lpEnvironment,</p>

<p>__in_opt� � � � LPCTSTR lpCurrentDirectory,</p>

<p>__in� � � � � � � � LPSTARTUPINFO lpStartupInfo,</p>

<p>__out� � � � � � � LPPROCESS_INFORMATION lpProcessInformation</p>

<p>);</p>
</blockquote>

<p>What does the Windows API documentation say about this?</p>

<blockquote>
<p>If this parameter is TRUE, each inheritable handle in the calling process is inherited by the new process. If the parameter is FALSE, the handles are not inherited. Note that inherited handles have the same value and access rights as the original handles.</p>
</blockquote>

<p>Inheritable handles?</p>

<blockquote>
<p><a href="http://msdn.microsoft.com/en-us/library/ms724466(v=vs.85).aspx" title="Handle Inheritance" target="_blank">Handle Inheritance</a></p>

<p>A child process can inherit handles from its parent process. An inherited handle is valid only in the context of the child process. To enable a child process to inherit open handles from its parent process, use the following steps.</p>

<ol>
<li>Create the handle with the bInheritHandle member of the SECURITY_ATTRIBUTES structure set to TRUE.</li>
<li>Create the child process using the CreateProcess function, with the bInheritHandles parameter set to TRUE.</li>
</ol>
</blockquote>

<p>Well if we look at the internals of .NET, and look at how the Process class is calling CreateProcess, we find that it’s passing bInheritHandles as TRUE.</p>

<p>So this means if we start a process using the System.Diagnostics classes, the child process will inherit our inheritable handles.</p>

<p>What was happening is the locked file handle to wsClient.exe was being inherited from the parent process to the Windows Installer, so the executable was remaining locked even when the parent process exited.</p>

<h2 id="solution">Solution</h2>

<p>One solution is to avoid System.Diagnostics in this particular instance, and use CreateProcess manually when we launch our child process, to ensure it doesn’t inherit handles.</p>

<p>I would recommend you use the System.Diagnostics classes in any other case.</p>

<h2 id="code">Code</h2>

<pre style="padding-bottom: 0px; line-height: normal; width: auto; background: #fdf6e3; overflow: visible;"><span style="font-family: &amp;amp;"><strong><span><span style="color: #859900;">using</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">System</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
</span><span><span style="color: #859900;">using</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">System</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #00008b;">Runtime</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #00008b;">ConstrainedExecution</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
</span><span><span style="color: #859900;">using</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">System</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #00008b;">Runtime</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #00008b;">InteropServices</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
</span><span><span style="color: #859900;">using</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">System</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #00008b;">Security</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
</span><span><span style="color: #859900;">using</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">System</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #00008b;">Security</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #00008b;">Permissions</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
</span><span><span style="color: #859900;">using</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">System</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #00008b;">Text</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
</span><span><span style="color: #859900;">using</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">Microsoft</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #00008b;">Win32</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #00008b;">SafeHandles</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;

</span><span><span style="color: #859900;">namespace</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">CreateProcessTest</span></span>
</strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">{
    [</span><span><span style="color: #00008b;">StructLayout</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">LayoutKind</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Sequential</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)]
    </span><span><span style="color: #859900;">internal</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">class</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">ProcessInformation</span></span>
</strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">    {
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">hProcess</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">hThread</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">dwProcessId</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">dwThreadId</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
    }

    [</span><span><span style="color: #00008b;">StructLayout</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">LayoutKind</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Sequential</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)]
    </span><span><span style="color: #859900;">internal</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">class</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">StartupInfo</span></span>
</strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">    {
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">cb</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">lpReserved</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">lpDesktop</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">lpTitle</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">dwX</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">dwY</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">dwXSize</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">dwYSize</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">dwXCountChars</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">dwYCountChars</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">dwFillAttribute</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">dwFlags</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">short</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">wShowWindow</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">short</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">cbReserved2</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">lpReserved2</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeFileHandle</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">hStdInput</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">new</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeFileHandle</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span><span style="color: #586e75;">, </span><span><span style="color: #859900;">false</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeFileHandle</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">hStdOutput</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">new</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeFileHandle</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span><span style="color: #586e75;">, </span><span><span style="color: #859900;">false</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeFileHandle</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">hStdError</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">new</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeFileHandle</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span><span style="color: #586e75;">, </span><span><span style="color: #859900;">false</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);

         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">StartupInfo</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">()
         {
             </span><span><span style="color: #800080;">dwY</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #2aa198;"></span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
             </span><span><span style="color: #800080;">cb</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">Marshal</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #008b8b;">SizeOf</span></span><span style="color: #586e75;">(</span><span><span style="color: #859900;">this</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);
         }

         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">void</span></span><span style="color: #586e75;"> </span><span><span style="color: #008b8b;">Dispose</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">()
         {
             </span><span><span style="color: #93a1a1;">// close the handles created for child process</span></span>
<span style="color: #586e75;">            </span><span><span style="color: #859900;"> if</span></span><span style="color: #586e75;"> (</span><span><span style="color: #800080;">hStdInput</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">!=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">null</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">&&</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">!</span></span><span><span style="color: #800080;">hStdInput</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">IsInvalid</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)
             {
                 </span><span><span style="color: #800080;">hStdInput</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #008b8b;">Close</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">();
                 </span><span><span style="color: #800080;">hStdInput</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">null</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
             }

             </span><span><span style="color: #859900;">if</span></span><span style="color: #586e75;"> (</span><span><span style="color: #800080;">hStdOutput</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">!=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">null</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">&&</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">!</span></span><span><span style="color: #800080;">hStdOutput</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">IsInvalid</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)
             {
                 </span><span><span style="color: #800080;">hStdOutput</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #008b8b;">Close</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">();
                 </span><span><span style="color: #800080;">hStdOutput</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">null</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
             }

             </span><span><span style="color: #859900;">if</span></span><span style="color: #586e75;"> (</span><span><span style="color: #800080;">hStdError</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">==</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">null</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">||</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">hStdError</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">IsInvalid</span></span><span style="color: #586e75;">) </span><span><span style="color: #859900;">return</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;

             </span><span><span style="color: #800080;">hStdError</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #008b8b;">Close</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">();
             </span><span><span style="color: #800080;">hStdError</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">null</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         }
     }

     [</span><span><span style="color: #00008b;">StructLayout</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">LayoutKind</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Sequential</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)]
     </span><span><span style="color: #859900;">internal</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">class</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SecurityAttributes</span></span>
</strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">     {
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">nLength</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #2aa198;">12</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeLocalMemHandle</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">lpSecurityDescriptor</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">new</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeLocalMemHandle</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span><span style="color: #586e75;">, </span><span><span style="color: #859900;">false</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);
         </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">bool</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">bInheritHandle</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
     }

     [</span><span><span style="color: #00008b;">SuppressUnmanagedCodeSecurity</span></span><span style="color: #586e75;">, </span><span><span style="color: #00008b;">HostProtection</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">SecurityAction</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">LinkDemand</span></span><span style="color: #586e75;">, </span><span><span style="color: #800080;">MayLeakOnAbort</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">true</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)]
     </span><span><span style="color: #859900;">internal</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">sealed</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">class</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeLocalMemHandle</span></span><span style="color: #586e75;"> : </span><span><span style="color: #00008b;">SafeHandleZeroOrMinusOneIsInvalid</span></span>
</strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">     {
         </span><span><span style="color: #859900;">internal</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeLocalMemHandle</span></span><span style="color: #586e75;">() : </span><span><span style="color: #00008b;">base</span></span><span style="color: #586e75;">(</span><span><span style="color: #859900;">true</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">) { }

         [</span><span><span style="color: #00008b;">SecurityPermission</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">SecurityAction</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">LinkDemand</span></span><span style="color: #586e75;">, </span><span><span style="color: #800080;">UnmanagedCode</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">true</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)]
         </span><span><span style="color: #859900;">internal</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeLocalMemHandle</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">IntPtr</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">existingHandle</span></span><span style="color: #586e75;">, </span><span><span style="color: #859900;">bool</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">ownsHandle</span></span><span style="color: #586e75;">) : </span><span><span style="color: #00008b;">base</span></span><span style="color: #586e75;">(</span><span><span style="color: #657b83;">ownsHandle</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)
         {
             </span><span><span style="color: #008b8b;">SetHandle</span></span><span style="color: #586e75;">(</span><span><span style="color: #657b83;">existingHandle</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);
         }

         [</span><span><span style="color: #00008b;">DllImport</span></span><span style="color: #586e75;">(</span><span><span style="color: #2aa198;">"advapi32.dll"</span></span><span style="color: #586e75;">, </span><span><span style="color: #800080;">CharSet</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">CharSet</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Auto</span></span><span style="color: #586e75;">, </span><span><span style="color: #800080;">SetLastError</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">true</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)]
         </span><span><span style="color: #859900;">internal</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">static</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">extern</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">bool</span></span><span style="color: #586e75;"> </span><span><span style="color: #008b8b;">ConvertStringSecurityDescriptorToSecurityDescriptor</span></span><span style="color: #586e75;">(</span><span><span style="color: #859900;">string</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">stringSecurityDescriptor</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">,
             </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">stringSDRevision</span></span><span style="color: #586e75;">, </span><span><span style="color: #859900;">out</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SafeLocalMemHandle</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">pSecurityDescriptor</span></span><span style="color: #586e75;">, </span><span><span style="color: #00008b;">IntPtr</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">securityDescriptorSize</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);

         [</span><span><span style="color: #00008b;">ReliabilityContract</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">Consistency</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">WillNotCorruptState</span></span><span style="color: #586e75;">, </span><span><span style="color: #00008b;">Cer</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Success</span></span><span style="color: #586e75;">), </span><span><span style="color: #00008b;">DllImport</span></span><span style="color: #586e75;">(</span><span><span style="color: #2aa198;">"kernel32.dll"</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)]
         </span><span><span style="color: #859900;">private</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">static</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">extern</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span style="color: #586e75;"> </span><span><span style="color: #008b8b;">LocalFree</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">IntPtr</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">hMem</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);

         </span><span><span style="color: #859900;">protected</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">override</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">bool</span></span><span style="color: #586e75;"> </span><span><span style="color: #008b8b;">ReleaseHandle</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">()
         {
             </span><span><span style="color: #859900;">return</span></span><span style="color: #586e75;"> (</span><span><span style="color: #008b8b;">LocalFree</span></span><span style="color: #586e75;">(</span><span><span style="color: #800080;">handle</span></span><span style="color: #586e75;">) </span><span><span style="color: #008b8b;">==</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);
         }
     }

     </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">static</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">class</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">Test</span></span>
</strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">     {
         </span><span><span style="color: #859900;">const</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #800080;">normalPriorityClass</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #2aa198;">0x0020</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;

         [</span><span><span style="color: #00008b;">DllImport</span></span><span style="color: #586e75;">(</span><span><span style="color: #2aa198;">"Kernel32"</span></span><span style="color: #586e75;">, </span><span><span style="color: #800080;">CharSet</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">CharSet</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Auto</span></span><span style="color: #586e75;">, </span><span><span style="color: #800080;">SetLastError</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">true</span></span><span style="color: #586e75;">, </span><span><span style="color: #800080;">BestFitMapping</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">false</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)]
         </span><span><span style="color: #859900;">internal</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">static</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">extern</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">bool</span></span><span style="color: #586e75;"> </span><span><span style="color: #008b8b;">CreateProcess</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">(
             [</span><span><span style="color: #00008b;">MarshalAs</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">UnmanagedType</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">LPTStr</span></span><span style="color: #586e75;">)]</span><span><span style="color: #859900;">string</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">applicationName</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">,
             </span><span><span style="color: #00008b;">StringBuilder</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">commandLine</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">,
             </span><span><span style="color: #00008b;">SecurityAttributes</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">processAttributes</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">,
             </span><span><span style="color: #00008b;">SecurityAttributes</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">threadAttributes</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">,
             </span><span><span style="color: #859900;">bool</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">inheritHandles</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">,
             </span><span><span style="color: #859900;">int</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">creationFlags</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">,
             </span><span><span style="color: #00008b;">IntPtr</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">environment</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">,
             [</span><span><span style="color: #00008b;">MarshalAs</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">UnmanagedType</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">LPTStr</span></span><span style="color: #586e75;">)]</span><span><span style="color: #859900;">string</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">currentDirectory</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">,
             </span><span><span style="color: #00008b;">StartupInfo</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">startupInfo</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">,
             </span><span><span style="color: #00008b;">ProcessInformation</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">processInformation</span></span>
</strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">        );

        </span><span><span style="color: #859900;">public</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">static</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">void</span></span><span style="color: #586e75;"> </span><span><span style="color: #008b8b;">Main</span></span><span style="color: #586e75;">(</span><span><span style="color: #859900;">string</span></span><span style="color: #586e75;">[] </span><span><span style="color: #657b83;">args</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">)
        {
            </span><span><span style="color: #93a1a1;">// We can use the string builder to build up our full command line, including arguments</span></span>
<span style="color: #586e75;">            </span><span><span style="color: #859900;">var</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">sb</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">new</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">StringBuilder</span></span><span style="color: #586e75;">(</span><span><span style="color: #2aa198;">"notepad.exe"</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);
            </span><span><span style="color: #859900;">var</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">processInformation</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">new</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">ProcessInformation</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">();
            </span><span><span style="color: #859900;">var</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">startupInfo</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">new</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">StartupInfo</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">();
            </span><span><span style="color: #859900;">var</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">processSecurity</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">new</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SecurityAttributes</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">();
            </span><span><span style="color: #859900;">var</span></span><span style="color: #586e75;"> </span><span><span style="color: #657b83;">threadSecurity</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #859900;">new</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">SecurityAttributes</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">();

            </span><span><span style="color: #657b83;">processSecurity</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">nLength</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">Marshal</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #008b8b;">SizeOf</span></span><span style="color: #586e75;">(</span><span><span style="color: #657b83;">processSecurity</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);
            </span><span><span style="color: #657b83;">threadSecurity</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">nLength</span></span><span style="color: #586e75;"> </span><span><span style="color: #d33682;">=</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">Marshal</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #008b8b;">SizeOf</span></span><span style="color: #586e75;">(</span><span><span style="color: #657b83;">threadSecurity</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">);

            </span><span><span style="color: #859900;">if</span></span><span style="color: #586e75;"> (</span><span><span style="color: #008b8b;">CreateProcess</span></span><span style="color: #586e75;">(</span><span><span style="color: #859900;">null</span></span><span style="color: #586e75;">, </span><span><span style="color: #657b83;">sb</span></span><span style="color: #586e75;">, </span><span><span style="color: #657b83;">processSecurity</span></span><span style="color: #586e75;">, </span><span><span style="color: #657b83;">threadSecurity</span></span><span style="color: #586e75;">, </span><span><span style="color: #859900;">false</span></span><span style="color: #586e75;">, </span><span><span style="color: #800080;">normalPriorityClass</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">,
                 </span><span><span style="color: #00008b;">IntPtr</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #800080;">Zero</span></span><span style="color: #586e75;">, </span><span><span style="color: #859900;">null</span></span><span style="color: #586e75;">, </span><span><span style="color: #657b83;">startupInfo</span></span><span style="color: #586e75;">, </span><span><span style="color: #657b83;">processInformation</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">))
            {
                </span><span><span style="color: #93a1a1;">// Process was created successfully</span></span>
<span style="color: #586e75;">                </span><span><span style="color: #859900;">return</span></span></strong></span><span style="font-family: &amp;amp;"><strong><span style="color: #586e75;">;
            }

            </span><span><span style="color: #93a1a1;">// We couldn't create the process, so raise an exception with the details.</span></span>
<span style="color: #586e75;">            </span><span><span style="color: #859900;">throw</span></span><span style="color: #586e75;"> </span><span><span style="color: #00008b;">Marshal</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #008b8b;">GetExceptionForHR</span></span><span style="color: #586e75;">(</span><span><span style="color: #00008b;">Marshal</span></span><span><span style="color: #d33682;">.</span></span><span><span style="color: #008b8b;">GetHRForLastWin32Error</span></span></strong><span style="color: #586e75;"><strong>());
         }
     }
}</strong></span></span></pre>

<h2 id="utilities">Utilities</h2>

<p>I used the invaluable <a href="http://technet.microsoft.com/en-nz/sysinternals/bb842062" target="_blank">SysInternals</a> tools Process Monitor, Process Explorer and Handle to diagnose what was going on.</p>

<h2 id="references">References</h2>

<p><a href="http://msdn.microsoft.com/en-us/library/ms724466(v=vs.85).aspx" target="_blank">Handle Inheritance @ MSDN</a></p>

<p><a href="http://social.msdn.microsoft.com/Forums/en-US/netfxbcl/thread/94ba760c-7080-4614-8a56-15582c48f900/" target="_blank">Child process keeps parent’s socket open – Diagnostics.Process and Net.TcpListene @ social.msdn.microsoft.com</a></p>

</div>

          

        </div>
      </div>
      <div class="order-0 w-20 dn db-l">
        
<nav role="navigation">
  <ul class="list pa0 nl2">
    
      
      <li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
        <a href="/blog/" class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2 " data-target=".latest-posts">Latest Posts</a>

          
        </li>
    
      
      <li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
        <a href="/categories/" class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2 " data-target=".categories">Categories</a>

          
        </li>
    
      
      <li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
        <a href="/tags/" class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2 " data-target=".tags">Tags</a>

          
        </li>
    
      
      <li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
        <a href="javascript:void(0)" class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2 " data-target=".archive">Archive</a>

          
            <ul class="archive desktopmenu animated fadeIn list pl0 bg-light-gray dn">
              
                <li  class="f6 fw4">
                  <a href="/blog/2017/" class="db link hover-bg-gray hover-white pl3 pr2 pv2 black ">
                    2017
                  </a>
                </li>
              
                <li  class="f6 fw4">
                  <a href="/blog/2016/" class="db link hover-bg-gray hover-white pl3 pr2 pv2 black ">
                    2016
                  </a>
                </li>
              
            </ul>
          
        </li>
    
  </ul>
</nav>

      </div>

    </div>
  </article>

  <div class="w-100 bg-light-gray">
    <div class="mw7 pa4 center nested-lh-copy lh-copy">
      <h6 class="f4 dark-gray mb2">
  <a href="http://www.sadrobot.co.nz/blog/2011/06/21/when-system-diagnostics-process-creates-a-process-it-inherits-inheritable-handles-from-the-parent-process/" class="hide-child link primary-color">
  <span class="nl3 child"><svg class="grow" fill="" height="14px" viewBox="0 0 24 24" width="14px" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
</span>
    “When System.Diagnostics.Process creates a process, it inherits inheritable handles from the parent process.”
  </a> was last updated: November 28, 2018
  
  
</h6>

      <a href="https://github.com/DavidMoore/SadRobot/edit/master/content/blog/2011-06-21-when-system-diagnostics-process-creates-a-process-it-inherits-inheritable-handles-from-the-parent-process.md" class="
f6 ph3 pv1 br2 dib  tc ttu mv3 bg-primary-color white hover-bg-green link
">Improve this page</a>

      


    </div>
  </div>

  <div class="w-60-l ph0 ph5-ns center">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "sadrobot" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>


    </main>

    <footer class="bg-primary-color-dark ph4-ns pt4 relative w-100" role="contentinfo">
    <div class="center flex-ns flex-wrap justify-between mw9 w-90">
      <div class="pb3 pt4 w-100">
      
         <div class="b f3  light-gray mb3 nested-links tc">
           Copyright &copy; David Moore 2018<br />
          </div>

          
            <div class="center w4">
                <svg version="1.1" id="Your_Icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="100px" height="98.953px" viewBox="0.859 1.023 100 98.953" enable-background="new 0.859 1.023 100 98.953"
	 xml:space="preserve">
<path d="M64.45,1.023H37.265v25.606H64.45V1.023L64.45,1.023z M44.258,18.443c-2.476,0-4.486-2.008-4.486-4.488
	c0-2.477,2.01-4.486,4.486-4.486c2.479,0,4.487,2.01,4.487,4.486C48.746,16.435,46.737,18.443,44.258,18.443z M57.457,18.443
	c-2.479,0-4.485-2.008-4.485-4.488c0-2.477,2.007-4.486,4.485-4.486s4.487,2.01,4.487,4.486
	C61.944,16.435,59.936,18.443,57.457,18.443z M95.212,57.515c-0.401-8.685-4.126-14.752-8.712-18.343
	c-3.793-2.979-7.954-4.407-11.396-4.913v-3.126h-48.49v3.125c-3.444,0.506-7.608,1.935-11.399,4.915
	c-4.592,3.59-8.311,9.655-8.708,18.339c-3.285,1.152-5.646,4.243-5.646,7.915c0,4.644,3.761,8.413,8.411,8.415v-3.737
	c-2.582-0.003-4.669-2.096-4.678-4.68c0.008-2.585,2.095-4.677,4.678-4.681c2.586,0.004,4.671,2.095,4.677,4.681h3.739
	c-0.004-3.757-2.479-6.902-5.878-7.982c0.435-7.118,3.271-11.364,6.694-14.121c2.59-2.075,5.633-3.203,8.112-3.693v29.249h4.324
	v19.227c-4.894,1.731-8.405,6.388-8.405,11.872h25.214c0-5.486-3.516-10.141-8.405-11.872V68.877h23.034v19.227
	c-4.892,1.731-8.405,6.388-8.405,11.872h25.215c0-5.486-3.514-10.141-8.405-11.872V68.877h4.323V39.63
	c2.477,0.488,5.519,1.616,8.106,3.691c3.425,2.756,6.262,7.001,6.698,14.12c-3.399,1.081-5.882,4.225-5.885,7.984h3.739
	c0.002-2.582,2.095-4.679,4.683-4.682c2.579,0.003,4.669,2.099,4.677,4.682c-0.008,2.58-2.098,4.675-4.677,4.679v3.737
	c4.644-0.003,8.413-3.769,8.413-8.416C100.858,61.749,98.49,58.663,95.212,57.515z M47.242,56.384h-4.822v-4.821h4.822V56.384z
	 M47.242,50.508h-4.822v-4.82h4.822V50.508z M53.267,56.384h-4.818v-4.821h4.818V56.384z M53.267,50.508h-4.818v-4.82h4.818V50.508z
	 M59.294,56.384h-4.825v-4.821h4.825V56.384z M59.294,50.508h-4.825v-4.82h4.825V50.508z M74.857,10.338
	c0-3.781-3.067-6.848-6.847-6.848v13.699C71.79,17.189,74.857,14.121,74.857,10.338z M33.703,17.189V3.491
	c-3.781,0-6.845,3.067-6.845,6.848C26.858,14.121,29.922,17.189,33.703,17.189z"/>
</svg>

              </div>

          <ul class="center f6 list ma0 mv3 pa0 tc">
            
          </ul>
          
          <ul class="center f6 list ma0 mv4 pa0 tc">
            <li class="dib mr3"><a href="https://twitter.com/whup" class="dim link light-gray pv2">@whup</a></li>
          </ul>

      </div>

      
      
    </div>

    <div class="f7 gray mb5 mb0-ns ph3 w-100"> 
      <p class="dib mr4">Theme based on Hugo Docs theme by Bud Parr.</p>
      <p class="dib">The Sad Robot logo is © Ricardo Moreira</p>
    </div>
    

    <div class="bg-primary-color-dark bottom-0 dn-ns fixed pb3 ph3 w-100"> 
      <div  class="globalmenu mobilemenu pb3 dn">
    

<ul class="list hidden dib ph0 ma0 scrolling-touch tc">
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/blog/" class="ttu f6 link primary-color-light overflow hover-white db brand-font  ma0 w-100 pv3 ph4">
          Blog
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/wiki/" class="ttu f6 link primary-color-light overflow hover-white db brand-font  ma0 w-100 pv3 ph4">
          Wiki
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/games/" class="ttu f6 link primary-color-light overflow hover-white db brand-font  ma0 w-100 pv3 ph4">
          Gaming
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/ipfilter/" class="ttu f6 link primary-color-light overflow hover-white db brand-font  ma0 w-100 pv3 ph4">
          IPFilter
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="https://github.com/davidmoore/" class="ttu f6 link primary-color-light overflow hover-white db brand-font  ma0 w-100 pv3 ph4">
          GitHub
        </a>
    </li>
  
</ul>

</div>
<div  class="docsmenu mobilemenu pb3 dn">
    

<ul class="list dib ph0 ma0 scrolling-touch tc">
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/about/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          About Me
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/getting-started/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Getting Started
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100 mb2 bb b--mid-gray">
        <a href="/themes/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Themes
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/content-management/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Content Management
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/templates/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Templates
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/functions/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Functions
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/variables/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Variables
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100 mb2 bb b--mid-gray">
        <a href="/commands/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          CLI
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/troubleshooting/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Troubleshooting
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/tools/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Tools
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/hosting-and-deployment/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Hosting &amp; Deployment
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100 mb2 bb b--mid-gray">
        <a href="/contribute/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Contribute
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/tags/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Tags
        </a>
    </li>
  
    <li  class="tl dib ma0 hover-bg-black w-100">
        <a href="/categories/" class="ttu f6 link primary-color-light  hover-white db brand-font mb1  ma0 w-100 pv2 ph4">
          Categories
        </a>
    </li>
  
</ul>

</div>

<div class="flex dn-l justify-between">
  <button class="js-toggle flex-auto dib dn-l f6 tc db mt4-ns ph3 pv2 link mr2 white bg-primary-color-dark hover-bg-primary-color ba b--white-40 w-auto" data-target=".globalmenu">Menu</button>

  <button class="js-toggle flex-auto dib dn-l f6 tc db mt4-ns ph3 pv2 link white bg-primary-color-dark hover-bg-primary-color ba b--white-40 w-auto" data-target=".docsmenu">Docs Menu</button>
</div>

    </div>

</footer>
    <script src="/dist/app.bundle.js"></script>




  </body>
</html>
